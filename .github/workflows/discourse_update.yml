name: Discourse Update

on:
  issues:
    types: [opened, edited]

jobs:
  update_discourse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      
      - name: Get Issue Details
        id: issue_details
        run: |
          echo "title=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "body=${{ github.event.issue.body }}" >> $GITHUB_ENV
          echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "status=${{ github.event.issue.state }}" >> $GITHUB_ENV
      
      - name: Fetch CSRF Token
        id: csrf_token
        run: |
          CSRF_TOKEN=$(curl -s https://goodbids.discourse.group/session/csrf.json | jq -r .csrf)
          echo "CSRF_TOKEN=${CSRF_TOKEN}" >> $GITHUB_ENV

      - name: Encode Emojis
        id: encode_emojis
        run: |
          ISSUE_BODY="${{ env.body }}"
          
          # Function to encode emojis as Unicode escape sequences
          function encode_emojis() {
              python3 -c 'import json; print(json.dumps("'${ISSUE_BODY}'", ensure_ascii=False))'
          }
          
          # Call the function and store the result in an environment variable
          ENCODED_BODY=$(encode_emojis)
          echo "ENCODED_BODY=${ENCODED_BODY}" >> $GITHUB_ENV
      
      - name: Post Update to Discourse
        run: |
          ISSUE_TITLE="${{ env.title }}"
          ISSUE_BODY="${{ env.ENCODED_BODY }}"
          ISSUE_AUTHOR="${{ env.author }}"
          ISSUE_STATUS="${{ env.status }}"
          CSRF_TOKEN="${{ env.CSRF_TOKEN }}"
          
          JSON_DATA="{\"title\": \"$ISSUE_TITLE\", \"raw\": \"$ISSUE_BODY\", \"category\": 22}"
          
          curl -X POST "https://goodbids.discourse.group/posts.json" \
               -H "Content-Type: application/json" \
               -H "Api-Key: ${{ secrets.DISCOURSE_UPDATE_SECRET }}" \
               -H "Api-Username: jaspercroome" \
               -H "X-CSRF-Token: $CSRF_TOKEN" \
               -d "$JSON_DATA"
